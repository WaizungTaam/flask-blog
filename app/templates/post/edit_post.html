{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block app_content %}
  <h1>Edit Post</h1>

  <form class="form" method="post" role="form" id="edit_post">
    {{ form.hidden_tag() }}
    {{ wtf.form_errors(form, hiddens="only") }}

    <div class="form-group required">
      <label class="control-label" for="title">Title</label>
      <input class="form-control" id="title" name="title" required type="text" value="{{ post.title }}">
    </div>

    <div class="form-group">
      <label class="control-label" for="content">Content</label>
      <input type="hidden" id="content" name="content">
      <input type="hidden" id="content_type" name="content_type">

      {% if post.content_type == 'md' %}
        <div id="markdown-editor">
          <textarea id="mde">{{ post.content|safe }}</textarea>
        </div>
      {% else %}
        <div id="wysiwyg-editor">
          <div id="ckeditor-toolbar"></div>
          <div id="ckeditor">{{ post.content|safe }}</div>
        </div>
      {% endif %}
    </div>

    <div class="form-group ">
      <label class="control-label" for="tag">Tag</label>
      <input class="form-control" id="tag" name="tag" type="text" value="{{ tags }}">
    </div>

    {{ wtf.form_field(form.submit) }}
  </form>
{% endblock %}

{%- block styles %}
  {{ super() }}
  <style>
    #ckeditor {
      border: 1px solid var(--ck-color-base-border);
      border-radius: var(--ck-border-radius);
      display: flex;
      flex-flow: column nowrap;
      min-height: calc(20 * var(--ck-font-size-base));
      padding-left: calc(var(--ck-font-size-base));
      padding-right: calc(var(--ck-font-size-base));
    }
  </style>
{%- endblock styles %}

{% block scripts %}
  {{ super() }}
  <script>
  {% if post.content_type == 'md' %}
  var mde = new SimpleMDE({
    element: $('#mde')[0]
  });
  {% else %}
  DecoupledEditor
    .create(document.querySelector('#ckeditor'))
    .then(editor => {
      const toolbar = document.querySelector('#ckeditor-toolbar');
      toolbar.appendChild(editor.ui.view.toolbar.element);
      window.ckeditor = editor;
    })
    .catch(error => {
      console.error(error);
    });
  {% endif %}
  
  $("#edit_post").submit(function (e) {
    {% if post.content_type == 'md' %}
      $('#content').val(mde.value());
      $('#content_type').val('md');
    {% else %}
      $('#content').val(ckeditor.getData());
      $('#content_type').val('html');
    {% endif %}
  });
  </script>
{%- endblock scripts %}
