{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block app_content %}
  <h1>New Post</h1>

  <form class="form" method="post" role="form" id="new_post">
    {{ form.hidden_tag() }}
    {{ wtf.form_errors(form, hiddens="only") }}

    {{ wtf.form_field(form.title) }}

    <div class="form-group">
      <label class="control-label" for="content">Content</label>

      <ul class="nav nav-tabs">
        <li class="nav-item active">
          <a class="nav-link" data-toggle="tab" href="#wysiwyg-editor">WYSIWYG</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" href="#markdown-editor">Markdown</a>
        </li>
      </ul>

      <div class="tab-content">

        <div id="wysiwyg-editor" class="tab-pane active" role="tabpanel">
          <div id="toolbar-container">
            <span class="ql-formats">
              <select class="ql-font"></select>
              <select class="ql-size"></select>
            </span>
            <span class="ql-formats">
              <button class="ql-bold"></button>
              <button class="ql-italic"></button>
              <button class="ql-underline"></button>
              <button class="ql-strike"></button>
            </span>
            <span class="ql-formats">
              <select class="ql-color"></select>
              <select class="ql-background"></select>
            </span>
            <span class="ql-formats">
              <button class="ql-script" value="sub"></button>
              <button class="ql-script" value="super"></button>
            </span>
            <span class="ql-formats">
              <button class="ql-header" value="1"></button>
              <button class="ql-header" value="2"></button>
              <button class="ql-blockquote"></button>
              <button class="ql-code-block"></button>
            </span>
            <span class="ql-formats">
              <button class="ql-list" value="ordered"></button>
              <button class="ql-list" value="bullet"></button>
              <button class="ql-indent" value="-1"></button>
              <button class="ql-indent" value="+1"></button>
            </span>
            <span class="ql-formats">
              <button class="ql-direction" value="rtl"></button>
              <select class="ql-align"></select>
            </span>
            <span class="ql-formats">
              <button class="ql-link"></button>
              <button class="ql-image"></button>
              <button class="ql-video"></button>
              <button class="ql-formula"></button>
            </span>
            <span class="ql-formats">
              <button class="ql-clean"></button>
            </span>
          </div>
          <div class="form-control" id="content" name="content" style="height: 20rem; font-size: 1.5rem;"></div>
        </div>

        <div id="markdown-editor" class="tab-pane" role="tabpanel">
          <textarea id="mde"></textarea>
        </div>

      </div>
    </div>

    {{ wtf.form_field(form.tag) }}
    {{ wtf.form_field(form.submit) }}
  </form>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
  var quill = new Quill('#content', {
    theme: 'snow',
    modules: {
      toolbar: '#toolbar-container'
    }
  });

  var mde = new SimpleMDE({
    element: $('#mde')[0]
  });

  $("#new_post").submit(function (e) {
    var content = '';
    var content_type = '';
    if ($('#wysiwyg-editor').hasClass('active')) {
      content = quill.root.innerHTML;
      content_type = 'html';
    } else if ($('#markdown-editor').hasClass('active')) {
      // content = mde.markdown(mde.value());
      content = mde.value();
      content_type = 'md';
    }
    $.post("/posts/new", {
      title: $("#title").val(),
      content: content,
      content_type: content_type,
      tag: $("#tag").val()
    }, function (res) {
      if (res.ok) {
        window.location = res.url;
      }
    });
    return false;
  });
  </script>
{%- endblock scripts %}
