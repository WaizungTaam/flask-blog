{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block app_content %}
  <h1>New Post</h1>

  <form class="form" method="post" role="form" id="new_post">
    {{ form.hidden_tag() }}
    {{ wtf.form_errors(form, hiddens="only") }}

    {{ wtf.form_field(form.title) }}

    <div class="form-group">
      <label class="control-label" for="content">Content</label>
      <input type="hidden" id="content" name="content">
      <input type="hidden" id="content_type" name="content_type">

      <ul class="nav nav-tabs">
        <li class="nav-item active">
          <a class="nav-link" data-toggle="tab" href="#wysiwyg-editor">WYSIWYG</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" href="#markdown-editor">Markdown</a>
        </li>
      </ul>

      <div class="tab-content">
        <div id="wysiwyg-editor" class="tab-pane active" role="tabpanel">
          <div id="ckeditor-toolbar"></div>
          <div id="ckeditor"></div>
        </div>
        <div id="markdown-editor" class="tab-pane" role="tabpanel">
          <textarea id="mde"></textarea>
        </div>

      </div>
    </div>

    {{ wtf.form_field(form.tag) }}
    {{ wtf.form_field(form.submit) }}
  </form>
{% endblock %}

{%- block styles %}
  {{ super() }}
  <style>
    #ckeditor {
      border: 1px solid var(--ck-color-base-border);
      border-radius: var(--ck-border-radius);
      display: flex;
      flex-flow: column nowrap;
      min-height: calc(20 * var(--ck-font-size-base));
      padding-left: calc(var(--ck-font-size-base));
      padding-right: calc(var(--ck-font-size-base));
    }
  </style>
{%- endblock styles %}

{% block scripts %}
  {{ super() }}
  <script>
  DecoupledEditor
    .create(document.querySelector('#ckeditor'))
    .then(editor => {
      const toolbar = document.querySelector('#ckeditor-toolbar');
      toolbar.appendChild(editor.ui.view.toolbar.element);
      window.ckeditor = editor;
    })
    .catch(error => {
      console.error(error);
    });

  var mde = new SimpleMDE({
    element: $('#mde')[0],
    autoDownloadFontAwesome: false,
    spellChecker: false
  });

  $("#new_post").submit(function (e) {
    if ($('#wysiwyg-editor').hasClass('active')) {
      $('#content').val(ckeditor.getData());
      $('#content_type').val('html');
    } else if ($('#markdown-editor').hasClass('active')) {
      $('#content').val(mde.value());
      $('#content_type').val('md');
    }
  });
  </script>
{%- endblock scripts %}
